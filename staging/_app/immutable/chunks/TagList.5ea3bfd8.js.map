{"version":3,"file":"TagList.5ea3bfd8.js","sources":["../../../../../../src/lib/components/utils/TagList.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { GetTagsDocument } from '$lib/generated/graphql';\n  import type { Tag } from '$lib/generated/graphql';\n  import Chip, { Set, Text } from '@smui/chips';\n  import MenuSurface from '@smui/menu-surface';\n  import { queryStore, getContextClient } from '@urql/svelte';\n  import Textfield, { Input } from '@smui/textfield';\n  import FloatingLabel from '@smui/floating-label';\n  import LineRipple from '@smui/line-ripple';\n\n  const client = getContextClient();\n\n  const getAllTags = queryStore({\n    query: GetTagsDocument,\n    client,\n    variables: {}\n  });\n\n  export let tags: Tag[] = [];\n  export let editable = false;\n\n  let inputA: Input;\n  let lineRippleA: LineRipple;\n\n  let shake = false;\n\n  let allTags: Tag[] = [];\n  let filteredTagsMatched: Tag[] = [];\n  let filteredTagsUnmatched: Tag[] = [];\n\n  let newTagText: string;\n\n  let newTag: HTMLInputElement;\n  let newTagContainer: HTMLElement = null;\n  let surface: MenuSurface;\n\n  let focused = false;\n\n  $: newTag = inputA?.getElement();\n\n  function filterAvailableTags(tagList: Tag[], currentTags: Tag[], filterText: string): [Tag[], Tag[]] {\n    if (!tagList || !currentTags) {\n      return [tagList, tagList];\n    }\n    let unfiltered = tagList.filter((tag) => !currentTags.find((t) => t.id == tag.id));\n    const filtered = unfiltered.filter((tag) => !newTag || tag.name.startsWith(filterText));\n    unfiltered = unfiltered.filter((tag) => filtered.findIndex((t) => t.id === tag.id) === -1);\n    return [filtered, unfiltered];\n  }\n\n  function updateTags() {\n    tags = tags;\n    [filteredTagsMatched, filteredTagsUnmatched] = filterAvailableTags(allTags, tags, newTagText);\n  }\n\n  $: if (editable) {\n    if (!$getAllTags.fetching && !$getAllTags.error) {\n      allTags = $getAllTags.data?.getTags || [];\n      updateTags();\n    }\n  }\n\n  function setTagText(text: string) {\n    newTagText = text;\n    newTag.value = newTagText;\n  }\n\n  export function setTextRange(el: HTMLInputElement, start: number, end: number): void {\n    el.focus();\n    if (typeof window.getSelection != 'undefined' && typeof document.createRange != 'undefined') {\n      el.setSelectionRange(start, end);\n    }\n  }\n\n  export function placeCaretAtEnd(el: HTMLInputElement): void {\n    el.focus();\n    if (typeof window.getSelection != 'undefined' && typeof document.createRange != 'undefined') {\n      el.setSelectionRange(el.value.length, el.value.length);\n    }\n  }\n\n  function addTag(newTagObj: string | Tag) {\n    if (!allTags) {\n      return false;\n    }\n    const tagToAdd = allTags.find((tag) => {\n      if (typeof newTagObj == 'string') {\n        return newTagObj == tag.name || newTagObj == tag.id;\n      } else {\n        return newTagObj.id == tag.id;\n      }\n    }) as Tag;\n    if (tagToAdd && !tags.find((tag) => tag.id == tagToAdd.id)) {\n      tags.push(tagToAdd);\n      updateTags();\n      return true;\n    }\n    updateTags();\n    return false;\n  }\n\n  function deleteTag(tag: Tag) {\n    tags = tags.filter((v) => v != tag);\n    updateTags();\n  }\n\n  function newTagKeydown(e: Event) {\n    if (!(e instanceof KeyboardEvent)) {\n      return;\n    }\n    if (e.code == 'Backspace') {\n      if (newTag.value == '') {\n        setTagText(tags.pop().name);\n        placeCaretAtEnd(newTag);\n        tags = tags;\n        e.preventDefault();\n        updateTags();\n      }\n    } else if (e.code == 'Enter') {\n      e.preventDefault();\n      if (addTag(newTag.value)) {\n        setTagText('');\n        updateTags();\n      } else {\n        shake = true;\n        setTimeout(() => (shake = false), 500);\n      }\n    } else {\n      const newText = newTagText + e.key;\n      const [available] = filterAvailableTags(allTags, tags, newText);\n      if (available && available.length > 0) {\n        newTag.value = available[0].name;\n        setTextRange(newTag, newTagText.length + 1, newTag.value.length);\n        e.preventDefault();\n        newTagText = newText;\n        updateTags();\n      }\n    }\n  }\n\n  function onFocusLost() {\n    setTimeout(() => {\n      if (newTagContainer && !newTagContainer.contains(document.activeElement)) {\n        surface.setOpen(false);\n      }\n    }, 200);\n  }\n\n  function onInput(e: Event) {\n    newTagText = newTag.value;\n    updateTags();\n    e.preventDefault();\n  }\n</script>\n\n<div class=\"tags\" on:focusin={() => (focused = true)} on:focusout={() => (focused = false)}>\n  {#if !editable}\n    {#if tags.length > 0}\n      <div class=\"flex flex-row flex-wrap text-sm gap-1\">\n        {#each tags as tag}\n          <div class=\"text-neutral-300 lowercase\">\n            <span class=\"text-orange-500\">#</span>{tag.name}\n          </div>\n        {/each}\n      </div>\n    {/if}\n  {:else}\n    <Textfield class=\"tags overflow-visible\" bind:lineRipple={lineRippleA} bind:input={inputA} style=\"z-index: 9999\">\n      <FloatingLabel\n        class=\"pb-2\"\n        for=\"input-manual-a\"\n        slot=\"label\"\n        floatAbove={(newTag && newTag.value.length > 0) || focused || tags.length > 0}>Tags</FloatingLabel>\n      <div class=\"flex flex-row flex-wrap text-sm gap-1 mr-2\">\n        {#each tags as tag}\n          <div class=\"text-neutral-300 whitespace-nowrap flex removable-tag\">\n            <span class=\"hashtag text-orange-500\">#</span>\n            <span class=\"cancel\">\n              <i\n                class=\"material-icons mdc-chip__icon mdc-chip__icon--trailing\"\n                on:click={() => deleteTag(tag)}\n                on:keypress={() => deleteTag(tag)}>cancel</i>\n            </span>\n            <p>{tag.name}</p>\n          </div>\n        {/each}\n        <div\n          id=\"newTagContainer\"\n          class=\"text-neutral-300 whitespace-nowrap flex\"\n          bind:this={newTagContainer}\n          on:focusin={() => surface.setOpen(true)}\n          on:focusout={onFocusLost}>\n          <MenuSurface bind:this={surface} managed={true} anchorCorner=\"BOTTOM_LEFT\" anchorElement={newTag}>\n            <div style=\"margin: 1rem\">\n              <h1>Available Tags</h1>\n              <div class=\"flex flex-wrap m-1\">\n                <Set chips={filteredTagsMatched} let:chip key={(tag) => tag.name}>\n                  <Chip {chip} on:SMUIChip:interaction={() => addTag(chip.name)}>\n                    <Text>{chip.name}</Text>\n                  </Chip>\n                </Set>\n              </div>\n              <div class=\"flex flex-wrap m-1\">\n                <Set chips={filteredTagsUnmatched} let:chip key={(tag) => tag.name}>\n                  <Chip {chip} on:SMUIChip:interaction={() => addTag(chip.name)}>\n                    <Text>{chip.name}</Text>\n                  </Chip>\n                </Set>\n              </div>\n            </div>\n          </MenuSurface>\n          {#if focused}\n            <span class=\"text-orange-500\">#</span>\n          {/if}\n          <Input\n            id=\"input-manual-a\"\n            spellcheck=\"false\"\n            autocomplete=\"off\"\n            class=\"inline text-sm text-neutral-300 {shake ? 'shake' : ''}\"\n            style=\"height: initial\"\n            bind:this={inputA}\n            on:keydown={newTagKeydown}\n            on:input={onInput} />\n        </div>\n      </div>\n      <LineRipple bind:this={lineRippleA} slot=\"ripple\" />\n    </Textfield>\n  {/if}\n</div>\n\n<style lang=\"scss\">\n  .removable-tag {\n    .cancel {\n      display: none;\n      cursor: pointer;\n\n      i {\n        padding: 0;\n        margin: 0;\n      }\n    }\n\n    &:hover {\n      .hashtag {\n        display: none;\n      }\n\n      .cancel {\n        display: initial;\n      }\n    }\n  }\n</style>\n"],"names":["ctx","length","create_if_block_1","t4_value","name","insert_hydration_dev","target","div","anchor","append_hydration_dev","span0","span1","i","p","dirty","set_data_dev","t4","t_value","t","div2","h1","div0","div1","span","create_if_block_2","floatAbove","value","floatinglabel_changes","t1_value","t1","setTextRange","el","start","end","focus","window","getSelection","document","createRange","setSelectionRange","placeCaretAtEnd","tag","client","getContextClient","getAllTags","queryStore","query","GetTagsDocument","variables","tags","$$props","editable","inputA","lineRippleA","shake","allTags","filteredTagsMatched","filteredTagsUnmatched","newTagText","newTag","newTagContainer","surface","focused","filterAvailableTags","tagList","currentTags","filterText","unfiltered","filter","find","id","filtered","startsWith","findIndex","updateTags","$$invalidate","setTagText","text","addTag","newTagObj","tagToAdd","push","deleteTag","v","newTagKeydown","e","KeyboardEvent","code","pop","preventDefault","setTimeout","newText","key","available","onFocusLost","contains","activeElement","setOpen","onInput","$$value","click_handler","keypress_handler","chip","focusin_handler_1","focusout_handler","getElement","$getAllTags","fetching","error","data","getTags"],"mappings":"o1BAuK8DA,EAAW,2BAAXA,EAAW,CAAA,GAAcA,EAAM,CAAA,IAAA,iBAANA,EAAM,CAAA,qTAA/BA,EAAW,2CAAcA,EAAM,+PAVpFA,EAAI,CAAA,EAACC,OAAS,GAACC,GAAAF,gIAAfA,EAAI,CAAA,EAACC,OAAS,8PA0BPE,EAAAH,MAAII,KAAI,4HAP0B,oCAKC,qIALD,oGAKC,ifANzCC,CAAAA,EASKC,EAAAC,EAAAC,GARHC,EAA6CF,EAAAG,iBAC7CD,EAKMF,EAAAI,CAJJF,EAAAA,EAG8CE,EAAAC,CAAAA,cAEhDH,EAAAA,EAAgBF,EAAAM,CAAAA,qGAAZC,EAAA,GAAA,GAAAX,KAAAA,EAAAH,IAAII,EAAAA,KAAI,KAAAW,GAAAC,EAAAb,oKAeG,IAAAc,EAAAjB,IAAKI,EAAAA,KAAI,oGAAT,CAAAU,EAAA,CAAA,EAAA,MAAAG,KAAAA,EAAAjB,MAAKI,KAAI,KAAAW,GAAAG,EAAAD,8yCAOT,IAAAA,EAAAjB,MAAKI,KAAI,qGAATU,EAAA,GAAA,MAAAG,KAAAA,EAAAjB,IAAKI,EAAAA,KAAI,KAAAW,GAAAG,EAAAD,CAAAA,81CATRjB,EAAmB,CAAA,oIAOnBA,EAAqB,CAAA,4JAT/B,iLAAA,6YADNK,CAAAA,EAgBKC,EAAAa,EAAAX,CAfHC,EAAAA,EAAsBU,EAAAC,CAAAA,gBACtBX,EAMKU,EAAAE,CAAAA,qBACLZ,EAMKU,EAAAG,kEAZStB,EAAmB,mFAOnBA,EAAqB,CAAA,gdASP,uEAAA,GAAA,wGAA9BK,CAAAA,EAAqCC,EAAAiB,EAAAf,mLAtClCR,EAAI,CAAA,iCAATC,OAAIW,GAAA,oCAkBsC,4CAAgDZ,EAAM,CAAA,yFAmB3FA,EAAO,EAAA,GAAAwB,GAAAxB,CAAAA,yGAO8BA,EAAK,CAAA,EAAG,QAAU,sFAG9CA,EAAa,EAAA,CAAA,gBACfA,EAAO,qlBAjDvBK,EAmDKC,EAAAgB,EAAAd,CAAAA,wDAtCHC,EAAAA,EAqCKa,EAAAD,CAAAA,4HAhCUrB,EAAW,EAAA,EAAA,GAAA,GAAA,GAAA,4CAjBnBA,EAAI,2BAATC,OAAIW,GAAA,EAAA,gHAAJX,6CAkB0FD,EAAM,CAAA,6DAmB3FA,EAAO,EAAA,kHAO8BA,EAAK,CAAA,EAAG,QAAU,8eA9CiB,6BAAA,saAAlEyB,WAAAzB,EAAU,CAAA,GAAAA,EAAO,CAAA,EAAA0B,MAAMzB,OAAS,GAAMD,EAAW,EAAAA,GAAAA,EAAK,GAAAC,OAAS,4LAA/Da,EAAA,CAAA,EAAA,OAAAa,EAAAF,WAAAzB,EAAU,CAAA,GAAAA,EAAO,CAAA0B,EAAAA,MAAMzB,OAAS,GAAMD,EAAW,EAAA,GAAAA,EAAK,CAAA,EAAAC,OAAS,osBAbrED,EAAI,kCAATC,OAAIW,GAAA,uTADRP,CAAAA,EAMKC,EAAAC,EAAAC,CAAAA,iFALIR,EAAI,2BAATC,OAAIW,GAAA,EAAA,mHAAJX,gLAEyC2B,EAAA5B,MAAII,KAAI,wDAAjB,uHAAA,qMADhCC,CAAAA,EAEKC,EAAAC,EAAAC,CADHC,EAAAA,EAAsCF,EAAAgB,wCAAC,CAAAT,EAAA,CAAA,EAAA,GAAAc,KAAAA,EAAA5B,MAAII,KAAI,KAAAW,GAAAc,EAAAD,CAAAA,oNALnD5B,EAAQ,CAAA,IAAA,4NADhBK,EAyEKC,EAAAC,EAAAC,CAAAA,ybAjKa,SAAAsB,EAAaC,EAAsBC,EAAeC,EAChEF,CAAAA,EAAGG,eACQC,OAAOC,aAAgB,YAAsBC,SAASC,YAAe,KAC9EP,EAAGQ,kBAAkBP,EAAOC,CAAAA,EAIhB,SAAAO,GAAgBT,EAAAA,CAC9BA,EAAGG,MAAAA,EACQC,OAAAA,OAAOC,aAAgB,KAAsBC,OAAAA,SAASC,YAAe,KAC9EP,EAAGQ,kBAAkBR,EAAGL,MAAMzB,OAAQ8B,EAAGL,MAAMzB,MAAAA,WAuHWwC,GAAQA,EAAIrC,QAOVqC,GAAQA,EAAIrC,4EAjMtE,MAAAsC,EAASC,GAET,EAAAC,EAAaC,GAAU,CAC3BC,MAAOC,GACPL,OACAM,EAAAA,UAAS,CAAA,CAAA,CAAA,mDAGAC,EAAI,CAAAC,CAAAA,EAAAA,EACJC,CAAAA,SAAAA,EAAW,EAAA,EAAKD,EAEvBE,EACAC,EAEAC,EAAQ,GAERC,EAAO,CAAA,EACPC,EAAmB,CAAA,EACnBC,EAAqB,GAErBC,EAEAC,EACAC,EAA+B,KAC/BC,EAEAC,EAAU,GAIL,SAAAC,EAAoBC,EAAgBC,EAAoBC,EAC1D,CAAA,GAAA,CAAAF,GAAYC,CAAAA,EACP,MAAA,CAAAD,EAASA,CAAAA,EAEf,IAAAG,EAAaH,EAAQI,OAAQ3B,GAASwB,CAAAA,EAAYI,KAAMnD,IAAMA,GAAEoD,IAAM7B,EAAI6B,EAAAA,CAAAA,EACxE,MAAAC,GAAWJ,EAAWC,OAAQ3B,GAAAA,CAASkB,GAAUlB,EAAIrC,KAAKoE,WAAWN,IAC3EC,OAAAA,EAAaA,EAAWC,OAAQ3B,GAAQ8B,GAASE,UAAWvD,IAAMA,GAAEoD,KAAO7B,EAAI6B,EAAAA,IAAAA,EACvE,EAAA,CAAAC,GAAUJ,YAGXO,gBAENlB,EAAqBC,CAAAA,EAAyBM,EAAoBR,EAASN,EAAMS,CAAAA,EAAUF,EAAAmB,EAAA,EAAAlB,CAAAA,CAAAA,EAUrF,SAAAmB,EAAWC,EAClBnB,CAAAA,EAAamB,MACblB,EAAOjC,MAAQgC,EAAUC,CAAAA,EAiBlB,SAAAmB,EAAOC,EAAAA,IACTxB,CAAAA,QACI,GAEH,MAAAyB,EAAWzB,EAAQc,KAAM5B,UAClBsC,GAAa,SACfA,GAAatC,EAAIrC,MAAQ2E,GAAatC,EAAI6B,GAE1CS,EAAUT,IAAM7B,EAAI6B,IAG3B,OAAAU,GAAAA,CAAa/B,EAAKoB,KAAM5B,GAAQA,EAAI6B,IAAMU,EAASV,KACrDrB,EAAKgC,KAAKD,CAAAA,EACVN,IACO,KAETA,IACO,IAGA,SAAAQ,EAAUzC,EAAAA,KACjBQ,EAAOA,EAAKmB,OAAQe,GAAMA,GAAK1C,CAC/BiC,CAAAA,EAAAA,EAAAA,EAGO,SAAAU,GAAcC,EACf,CAAA,GAAAA,aAAaC,iBAGfD,EAAEE,MAAQ,YACR5B,EAAOjC,OAAS,KAClBkD,EAAW3B,EAAKuC,IAAAA,EAAMpF,IACtBoC,EAAAA,GAAgBmB,UAEhB0B,EAAEI,eACFf,EAAAA,EAAAA,WAEOW,EAAEE,MAAQ,QACnBF,EAAEI,eAAAA,EACEX,EAAOnB,EAAOjC,KAAAA,GAChBkD,EAAW,IACXF,MAEAC,EAAA,EAAArB,EAAQ,EACRoC,EAAAA,WAAkB,IAAAf,EAAA,EAAArB,EAAQ,EAAQ,EAAA,GAAA,QAG9B,MAAAqC,EAAUjC,EAAa2B,EAAEO,IACxB,CAAAC,CAAa9B,EAAAA,EAAoBR,EAASN,EAAM0C,CAAAA,EACnDE,GAAaA,EAAU5F,OAAS,IAClC0E,EAAA,EAAAhB,EAAOjC,MAAQmE,EAAU,CAAGzF,EAAAA,KAAIuD,CAChC7B,EAAAA,EAAa6B,EAAQD,EAAWzD,OAAS,EAAG0D,EAAOjC,MAAMzB,MAAAA,EACzDoF,EAAEI,eAAAA,EACF/B,EAAaiC,EACbjB,EAAAA,aAKGoB,IACPJ,CAAAA,gBACM9B,GAAAA,CAAoBA,EAAgBmC,SAAS1D,SAAS2D,aAAAA,GACxDnC,EAAQoC,QAAQ,KAEjB,KAGI,SAAAC,GAAQb,EACf3B,CAAAA,EAAaC,EAAOjC,MACpBgD,EACAW,EAAAA,EAAEI,sOA0EuBpC,EAAW8C,WA7CR,MAAAC,GAAA3D,GAAAyC,EAAUzC,CACP,EAAA4D,GAAA5D,GAAAyC,EAAUzC,SAgBiBqC,EAAOwB,EAAKlG,YAOZ0E,EAAOwB,EAAKlG,IAAAA,4CAZxCyD,EAAOsC,oDA4BlB/C,CAAAA,EAAM+C,qDA/BRvC,EAAeuC,wBACRtC,EAAQoC,QAAQ,EAAA,gBAvBkB5C,CAAAA,EAAW3B,uBAAc0B,CAAAA,EAAM1B,SAZxD,MAAA6E,GAAA,IAAA5B,EAAA,GAAAb,EAAU,EAAA,EAA2B0C,GAAA,IAAA7B,EAAA,GAAAb,EAAU,+pCArH/Ea,EAAA,EAAAhB,EAASP,GAAQqD,oCAiBbtD,GACA,CAAAuD,EAAYC,UAAAA,CAAaD,EAAYE,QACxCrD,EAAUmD,EAAYG,MAAMC,SAAO,CACnCpC,EAAAA,EAAAA"}