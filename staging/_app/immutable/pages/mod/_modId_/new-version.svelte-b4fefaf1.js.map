{"version":3,"file":"new-version.svelte-b4fefaf1.js","sources":["../../../../../../../../src/lib/utils/chunked-upload.ts","../../../../../../../../src/routes/mod/[modId]/new-version.svelte"],"sourcesContent":["/* eslint-disable */\n\nimport type { File } from '$lib/models/file';\nimport type { ExecuteMutation, OperationStore } from '@urql/svelte';\nimport type {\n  CheckVersionUploadStateQuery,\n  CreateVersionMutation,\n  Exact,\n  FinalizeCreateVersionMutation,\n  NewVersion,\n  UploadVersionPartMutation\n} from '$lib/generated';\nimport type { Writable } from 'svelte/store';\n\nexport type UploadState = {\n  total: number;\n  uploaded: number;\n};\n\nexport type ChunkedResponse = CheckVersionUploadStateQuery['checkVersionUploadState'];\n\nexport const chunkedUpload = async (\n  file: File,\n  modId: string,\n  version: NewVersion,\n  state: Writable<UploadState>,\n  gql: {\n    createVersion: ExecuteMutation<CreateVersionMutation, Exact<{ modId: any }>>;\n    uploadVersionPart: ExecuteMutation<\n      UploadVersionPartMutation,\n      Exact<{ modId: any; versionId: any; part: number; file: any }>\n    >;\n    finalizeCreateVersion: ExecuteMutation<\n      FinalizeCreateVersionMutation,\n      Exact<{ modId: any; versionId: any; version: NewVersion }>\n    >;\n    checkVersionUploadState: OperationStore<\n      CheckVersionUploadStateQuery,\n      Exact<{ modId: any; versionId: any }>,\n      CheckVersionUploadStateQuery\n    >;\n  }\n): Promise<ChunkedResponse> => {\n  const chunkSize = 10000000; // ~ 10MB\n\n  const chunksQuantity = Math.ceil(file.size / chunkSize);\n  const chunksQueue = new Array(chunksQuantity)\n    .fill(0)\n    .map((_, index) => index)\n    .reverse();\n\n  const upload = (chunk: Blob, chunkId: number, versionID: string) => {\n    return gql.uploadVersionPart({\n      modId: modId,\n      versionId: versionID,\n      part: chunkId,\n      file: chunk\n    });\n  };\n\n  const threadsQuantity = 10;\n  let activeConnections = 0;\n  let retries = 0;\n  const sendNext = (versionID: string) => {\n    if (activeConnections >= threadsQuantity) {\n      return;\n    }\n\n    if (!chunksQueue.length) {\n      return;\n    }\n\n    const chunkId = chunksQueue.pop();\n    const begin = chunkId * chunkSize;\n    const chunk = file.slice(begin, begin + chunkSize);\n\n    activeConnections += 1;\n\n    return Promise.all([\n      upload(chunk, chunkId + 1, versionID)\n        .then(() => {\n          activeConnections -= 1;\n\n          state.set({\n            total: chunksQuantity,\n            uploaded: chunksQuantity - chunksQueue.length - activeConnections\n          });\n\n          return sendNext(versionID);\n        })\n        .catch((err) => {\n          console.error('Upload failed:', err);\n          activeConnections -= 1;\n          chunksQueue.push(chunkId);\n          retries += 1;\n          if (retries < 5) {\n            return sendNext(versionID);\n          } else {\n            throw new Error('Failed uploading after 5 attempts');\n          }\n        }),\n      sendNext(versionID)\n    ]);\n  };\n\n  return gql\n    .createVersion({ modId })\n    .then(async (data) => {\n      state.set({\n        total: chunksQuantity,\n        uploaded: 0\n      });\n\n      await sendNext(data.data.createVersion);\n\n      return data.data.createVersion;\n    })\n    .then((versionID) => {\n      console.log('Finalizing', { versionID });\n\n      return gql\n        .finalizeCreateVersion({\n          modId: modId,\n          versionId: versionID,\n          version: version\n        })\n        .then(() => {\n          return new Promise<ChunkedResponse>((resolve, reject) => {\n            let tries = 0;\n            const interval = setInterval(() => {\n              if (tries == 60) {\n                clearInterval(interval);\n                return reject(new Error('Timed out waiting for mod processing'));\n              }\n\n              gql.checkVersionUploadState.reexecute({\n                requestPolicy: 'network-only'\n              });\n              tries++;\n            }, 10000);\n\n            gql.checkVersionUploadState.variables.versionId = versionID;\n            const sub = gql.checkVersionUploadState.subscribe((data) => {\n              if (data.fetching) {\n                return;\n              }\n\n              if (data.error) {\n                clearInterval(interval);\n                reject(new Error(data.error.message));\n                setTimeout(sub);\n                return;\n              }\n\n              if (!data.data) {\n                return;\n              }\n\n              if (!data.data.checkVersionUploadState) {\n                return;\n              }\n\n              if (!data.data.checkVersionUploadState.version) {\n                return;\n              }\n\n              if (!data.data.checkVersionUploadState.version.id) {\n                return;\n              }\n\n              sub();\n              clearInterval(interval);\n              resolve(data.data.checkVersionUploadState);\n            });\n          });\n        });\n    })\n    .catch((err) => {\n      console.error(err);\n      throw err;\n    });\n};\n","<script lang=\"ts\" context=\"module\">\n  import { paramsToProps } from '$lib/utils/routing';\n\n  export const load = paramsToProps();\n</script>\n\n<script lang=\"ts\">\n  import { mutation, operationStore, query } from '@urql/svelte';\n  import Toast from '$lib/components/general/Toast.svelte';\n  import { goto } from '$app/navigation';\n  import type { VersionData } from '$lib/models/versions';\n  import VersionForm from '$lib/components/versions/VersionForm.svelte';\n  import {\n    CheckVersionUploadStateDocument,\n    CreateVersionDocument,\n    FinalizeCreateVersionDocument,\n    GetModReferenceDocument,\n    UploadVersionPartDocument\n  } from '$lib/generated';\n  import { get, writable } from 'svelte/store';\n  import { chunkedUpload } from '$lib/utils/chunked-upload';\n  import type { UploadState } from '$lib/utils/chunked-upload';\n  import { base } from '$app/paths';\n  import MetaDescriptors from '$lib/components/utils/MetaDescriptors.svelte';\n  import Card, { Content } from '@smui/card';\n\n  export let modId!: string;\n\n  const uploadStatus = writable<undefined | string>('');\n  const uploadPercent = writable<number>(0);\n\n  const uploadState = writable<UploadState>();\n\n  uploadState.subscribe((up) => {\n    if (up) {\n      if (up.uploaded === up.total) {\n        uploadStatus.set(`Processing...`);\n        uploadPercent.set(100);\n      } else {\n        uploadStatus.set(`Uploading: ${up.uploaded}/${up.total}`);\n        uploadPercent.set((up.uploaded / up.total) * 100);\n      }\n    }\n  });\n\n  let errorMessage = '';\n  let errorToast = false;\n\n  const mod = operationStore(GetModReferenceDocument, { mod: modId });\n\n  query(mod);\n\n  const createVersion = mutation({\n    query: CreateVersionDocument\n  });\n\n  const uploadVersionPart = mutation({\n    query: UploadVersionPartDocument\n  });\n\n  const finalizeCreateVersion = mutation({\n    query: FinalizeCreateVersionDocument\n  });\n\n  const checkVersionUploadState = operationStore(\n    CheckVersionUploadStateDocument,\n    {\n      versionId: undefined,\n      modId: undefined\n    },\n    {\n      pause: true\n    }\n  );\n\n  $: $mod.data && (checkVersionUploadState.variables.modId = $mod.data.mod.id);\n\n  query(checkVersionUploadState);\n\n  const onSubmit = async (data: VersionData) =>\n    chunkedUpload(\n      data.file,\n      get(mod).data.mod.id,\n      {\n        changelog: data.changelog,\n        stability: data.stability\n      },\n      uploadState,\n      {\n        createVersion,\n        uploadVersionPart,\n        finalizeCreateVersion,\n        checkVersionUploadState\n      }\n    )\n      .then((success) => {\n        console.log({ success });\n        // TODO Toast or something\n        goto(base + '/mod/' + modId + '/version/' + success.version.id);\n      })\n      .catch((err) => {\n        console.error(err);\n        errorMessage = 'Error creating version: ' + err.message;\n        errorToast = true;\n        uploadStatus.set('');\n      });\n\n  $: if (!errorToast) {\n    errorMessage = '';\n  }\n</script>\n\n<svelte:head>\n  {#if !$mod.fetching && !$mod.error && $mod.data.mod}\n    <MetaDescriptors\n      description=\"Creating a new version of mod {$mod.data.mod.name}\"\n      title=\"New version of mod {$mod.data.mod.name}\" />\n  {/if}\n</svelte:head>\n\n<h1 class=\"text-4xl my-4 font-bold\">\n  New Version for\n  {#if $mod.fetching}\n    ...\n  {:else if !$mod.error}\n    {$mod.data.mod.name}\n  {/if}\n</h1>\n\n<Card>\n  <Content>\n    {#if $mod.fetching}\n      <p>Loading...</p>\n    {:else if $mod.error}\n      <p>Oh no... {$mod.error.message}</p>\n    {:else}\n      <VersionForm {onSubmit} modReference={$mod.data.mod.mod_reference} />\n\n      {#if $uploadStatus}\n        <div class=\"relative pt-4\">\n          <div class=\"flex mb-2 items-center justify-between\">\n            <div>\n              <span\n                class=\"text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600\">\n                {$uploadStatus}\n              </span>\n            </div>\n            <div class=\"text-right\">\n              <span class=\"text-xs font-semibold inline-block text-white\">{$uploadPercent.toFixed(0)}%</span>\n            </div>\n          </div>\n          <div class=\"overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600\">\n            <div\n              style=\"width: {$uploadPercent.toFixed(0)}%\"\n              class=\"shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600\" />\n          </div>\n        </div>\n      {/if}\n    {/if}\n  </Content>\n</Card>\n\n<Toast bind:running={errorToast}>\n  <span>{errorMessage}</span>\n</Toast>\n"],"names":["chunkedUpload","async","file","modId","version","state","gql","chunksQuantity","Math","ceil","size","chunkSize","chunksQueue","Array","fill","map","_","index","reverse","upload","chunk","chunkId","versionID","uploadVersionPart","versionId","part","threadsQuantity","activeConnections","retries","sendNext","length","pop","begin","slice","Promise","all","then","set","total","uploaded","catch","err","console","error","push","Error","createVersion","data","log","finalizeCreateVersion","resolve","reject","tries","interval","setInterval","clearInterval","checkVersionUploadState","reexecute","requestPolicy","variables","sub","subscribe","fetching","message","setTimeout","id","description","ctx","mod","name","title","dirty","metadescriptors_changes","t_value","set_data","t","modReference","mod_reference","create_if_block_2","versionform_changes","insert_hydration","target","p","anchor","t1","t1_value","toFixed","div5","append_hydration","div2","div0","span0","div1","span1","div4","div3","t2","t2_value","span","create_if_block_5","create_if_block_3","create_if_block_4","h1","load","paramsToProps","$$props","uploadStatus","writable","uploadPercent","uploadState","up","errorMessage","errorToast","operationStore","GetModReferenceDocument","query","mutation","CreateVersionDocument","UploadVersionPartDocument","FinalizeCreateVersionDocument","CheckVersionUploadStateDocument","undefined","pause","onSubmit","get","changelog","stability","success","goto","base","$$invalidate","value","$mod"],"mappings":"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"}